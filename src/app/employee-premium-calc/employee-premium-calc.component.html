<div class="premium-calc-container">
  <div class="top-bar">
    <button class="home-btn" (click)="goHome()">ホームへ戻る</button>
  </div>
  <h2 class="main-title">従業員ごとの保険料自動算出</h2>
  <form class="search-form" (submit)="$event.preventDefault()">
    <div class="form-fields">
      <div class="form-group">
        <label for="searchEmployeeNo">従業員番号</label>
        <input id="searchEmployeeNo" [(ngModel)]="searchEmployeeNo" name="searchEmployeeNo" type="text" placeholder="社員番号で検索" autocomplete="off" />
      </div>
      <div class="form-group">
        <label>給与計算年</label>
        <select [(ngModel)]="pendingSalaryYear" name="pendingSalaryYear" (change)="updateSalaryMonth()">
          <option value="">--</option>
          <option *ngFor="let y of salaryYearOptions" [value]="y">{{y}}</option>
        </select>
      </div>
      <div class="form-group">
        <label>給与計算月</label>
        <select [(ngModel)]="pendingSalaryMonthOnly" name="pendingSalaryMonthOnly" (change)="updateSalaryMonth()">
          <option value="">--</option>
          <option *ngFor="let m of salaryMonthOnlyOptions" [value]="m">{{m}}</option>
        </select>
      </div>
      <div class="form-group" style="align-self: flex-end; min-width: 120px; display: flex; gap: 8px;">
        <button class="search-btn" type="button" (click)="onSearch()">検索</button>
        <button class="search-btn" type="button" (click)="onClearSearch()">クリア</button>
      </div>
    </div>
  </form>
  <div *ngIf="loading">読み込み中...</div>
  <div *ngIf="noEmployeeFound" style="color: #e74c3c; margin-bottom: 8px;">
    対象の従業員はいません
  </div>
  <div *ngIf="salaryNotFoundMessage" style="color: #e74c3c; margin-bottom: 8px;">
    {{salaryNotFoundMessage}}
  </div>
  <table class="employee-table" *ngIf="!loading">
    <thead>
      <tr>
        <th>従業員番号</th>
        <th>氏名</th>
        <th>報酬（月額）</th>
        <th>賞与</th>
        <th>等級</th>
        <th>標準報酬月額</th>
        <th>健康保険料<br>（会社/本人）</th>
        <th>介護保険料<br>（会社/本人）</th>
        <th>厚生年金保険料<br>（会社/本人）</th>
      </tr>
    </thead>
    <tbody *ngIf="!salaryNotFoundMessage">
      <tr *ngFor="let e of employees"
          [ngClass]="{'manual-row': e.manualInsuranceEdit}"
          [attr.title]="e.manualInsuranceEdit ? '社会保険加入状況を手動変更した算出結果です。' : null">
        <td>{{e.employee_no}}</td>
        <td>{{e.full_name}}</td>
        <td>{{premiumMap[e.employee_no]?.salary | number}}</td>
        <td>{{e.bonus | number}}</td>
        <td>{{premiumMap[e.employee_no]?.grade}}</td>
        <td>{{premiumMap[e.employee_no]?.standard | number}}</td>
        <td>
          <span [ngClass]="{'manual-value': e.manualInsuranceEdit}">
            {{premiumMap[e.employee_no]?.healthCompany | number:'1.2-2'}}
          </span>
          /
          <span [ngClass]="{'manual-value': e.manualInsuranceEdit}">
            {{premiumMap[e.employee_no]?.healthPersonal | number:'1.2-2'}}
          </span>
        </td>
        <td>
          <ng-container *ngIf="!premiumMap[e.employee_no]?.careError; else careErrorTpl">
            <span [ngClass]="{'manual-value': e.manualInsuranceEdit}">
              {{premiumMap[e.employee_no]?.careCompany | number:'1.1-1'}}
            </span>
            /
            <span [ngClass]="{'manual-value': e.manualInsuranceEdit}">
              {{premiumMap[e.employee_no]?.carePersonal | number:'1.1-1'}}
            </span>
          </ng-container>
          <ng-template #careErrorTpl>
            <span class="error-msg">{{premiumMap[e.employee_no]?.careError}}</span>
          </ng-template>
        </td>
        <td>
          <span [ngClass]="{'manual-value': e.manualInsuranceEdit}">
            {{premiumMap[e.employee_no]?.pensionCompany | number:'1.2-2'}}
          </span>
          /
          <span [ngClass]="{'manual-value': e.manualInsuranceEdit}">
            {{premiumMap[e.employee_no]?.pensionPersonal | number:'1.2-2'}}
          </span>
        </td>
      </tr>
    </tbody>
  </table>
</div> 